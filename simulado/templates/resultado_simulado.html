{% extends 'base.html' %}
{% load static %}

{% block 'head' %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block 'body' %}
<div class="container mt-5">
    <h1>Resultado do Simulado</h1>
    <p class="lead">Análise detalhada do seu desempenho.</p>

    <div class="row mb-4 text-center">
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5>Nota Total</h5>
                <h2 class="text-primary">{{ nota_total|floatformat:2 }}%</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5>Acertos</h5>
                <h2 class="text-success">{{ acertos }} / {{ total_questoes }}</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5>Erros</h5>
                <h2 class="text-danger">{{ erros }} / {{ total_questoes }}</h2>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0">Desempenho por Matéria</h4>
        </div>
        <div class="card-body">
            <canvas id="myChart"></canvas>
        </div>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0">Gabarito Comentado</h4>
        </div>
        <div class="card-body">
            {% for resposta in respostas %}
            <div class="p-3 mb-3 border rounded {% if resposta.correta %}border-success{% else %}border-danger{% endif %}">
                <h5><strong>Questão #{{ resposta.questao.id }}</strong> - {{ resposta.questao.materia.nome }} / {{ resposta.questao.assunto.nome }}</h5>
                <p class="card-text">
                    {{ resposta.questao.enunciado|safe }}
                </p>
                <hr>
                <ul class="list-group">
                    <li class="list-group-item {% if resposta.alternativa_escolhida == 'A' %}
                        {% if resposta.correta %}bg-success text-white{% else %}bg-danger text-white{% endif %}
                    {% elif resposta.questao.resposta_correta == 'A' %}bg-warning{% endif %}">
                        A) {{ resposta.questao.alternativa_a|safe }}
                    </li>
                    <li class="list-group-item {% if resposta.alternativa_escolhida == 'B' %}
                        {% if resposta.correta %}bg-success text-white{% else %}bg-danger text-white{% endif %}
                    {% elif resposta.questao.resposta_correta == 'B' %}bg-warning{% endif %}">
                        B) {{ resposta.questao.alternativa_b|safe }}
                    </li>
                    <li class="list-group-item {% if resposta.alternativa_escolhida == 'C' %}
                        {% if resposta.correta %}bg-success text-white{% else %}bg-danger text-white{% endif %}
                    {% elif resposta.questao.resposta_correta == 'C' %}bg-warning{% endif %}">
                        C) {{ resposta.questao.alternativa_c|safe }}
                    </li>
                    <li class="list-group-item {% if resposta.alternativa_escolhida == 'D' %}
                        {% if resposta.correta %}bg-success text-white{% else %}bg-danger text-white{% endif %}
                    {% elif resposta.questao.resposta_correta == 'D' %}bg-warning{% endif %}">
                        D) {{ resposta.questao.alternativa_d|safe }}
                    </li>
                    <li class="list-group-item {% if resposta.alternativa_escolhida == 'E' %}
                        {% if resposta.correta %}bg-success text-white{% else %}bg-danger text-white{% endif %}
                    {% elif resposta.questao.resposta_correta == 'E' %}bg-warning{% endif %}">
                        E) {{ resposta.questao.alternativa_e|safe }}
                    </li>
                </ul>
                <div class="mt-3">
                    <p><strong>Sua resposta:</strong> <span class="badge bg-{% if resposta.correta %}success{% else %}danger{% endif %}">{{ resposta.alternativa_escolhida }}</span></p>
                    <p><strong>Resposta Correta:</strong> <span class="badge bg-warning text-dark">{{ resposta.questao.resposta_correta }}</span></p>
                </div>
                {% if resposta.questao.comentario_resposta %}
                <div class="mt-3">
                    <h6 class="card-subtitle mb-2 text-muted">Comentário da Resposta:</h6>
                    <div class="card-text">
                        {{ resposta.questao.comentario_resposta|safe }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('myChart');
    const labels = {{ chart_labels|safe }};
    const data = {{ chart_data|safe }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '% de Acertos',
                data: data,
                backgroundColor: [
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
</script>
{% endblock %}